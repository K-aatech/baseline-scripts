name: Secret Scanning (TruffleHog)

permissions:
    contents: read
    security-events: write

on:
    pull_request:
        branches:
        - main
    schedule:
        - cron: '0 4 * * 3' # Wednesday 04:00 UTC

concurrency:
    group: trufflehog-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    trufflehog-scan:
        name: TruffleHog OSS Scan
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
          - name: Checkout (full history)
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            with:
                fetch-depth: 0

          - name: Run TruffleHog (JSON)
            uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004 # v3.93.3

          # PR → diff only
          - name: Run TruffleHog (PR diff scan)
            if: github.event_name == 'pull_request'
            run: |
                trufflehog git file://. \
                --since-commit ${{ github.event.pull_request.base.sha }} \
                --branch ${{ github.event.pull_request.head.sha }} \
                --results=verified,unknown \
                --json > trufflehog.json

          # Schedule → full history
          - name: Run TruffleHog (Full scan)
            if: github.event_name == 'schedule'
            run: |
                trufflehog git file://. \
                --results=verified,unknown \
                --json > trufflehog.json

          # Convert JSON → SARIF
          - name: Convert to SARIF
            if: always()
            run: |
                jq -n '
                {
                    version: "2.1.0",
                    runs: [
                    {
                        tool: {
                        driver: {
                            name: "TruffleHog",
                            informationUri: "https://github.com/trufflesecurity/trufflehog",
                            rules: []
                        }
                        },
                        results: [
                        inputs[]
                        | {
                            ruleId: (.DetectorName // "SecretDetected"),
                            message: { text: (.Raw // "Secret detected") },
                            locations: [
                                {
                                physicalLocation: {
                                    artifactLocation: { uri: .SourceMetadata.Data.Git.file },
                                    region: {
                                    startLine: (.SourceMetadata.Data.Git.line // 1)
                                    }
                                }
                                }
                            ]
                            }
                        ]
                    }
                    ]
                }' trufflehog.json > trufflehog.sarif

          - name: Upload SARIF
            if: always() && hashFiles('trufflehog.sarif') != ''
            uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6
            with:
                sarif_file: trufflehog.sarif

          # Fail explicitly if findings exist
          - name: Enforce fail on detection
            if: always()
            run: |
                if [ -s trufflehog.json ]; then
                    echo "Secrets detected."
                    exit 1
                fi
