name: Secret Scanning (TruffleHog)

permissions:
    contents: read
    security-events: write

on:
    pull_request:
        branches:
        - main
    schedule:
        - cron: '0 4 * * 3' # Wednesday 04:00 UTC

concurrency:
    group: trufflehog-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    trufflehog-scan:
        name: TruffleHog OSS Scan
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
          - name: Checkout (full history)
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            with:
                fetch-depth: 0
                ref: ${{ github.event.pull_request.head.sha }} # Forzamos el checkout al commit del PR

          - name: Download and verify TruffleHog
            run: |
                VERSION=3.93.3
                FILE=trufflehog_${VERSION}_linux_amd64.tar.gz

                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/${FILE} -o ${FILE}
                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/trufflehog_${VERSION}_checksums.txt -o checksums.txt

                grep ${FILE} checksums.txt | sha256sum -c -

                tar -xzf ${FILE}
                chmod +x trufflehog

          - name: Run TruffleHog (Git scan)
            # Usamos git en ambos casos. PR escanea el diff; Schedule escanea todo.
            # Definimos el punto de comparación de forma dinámica
            run: |
                if [ "${{ github.event_name }}" == "pull_request" ]; then
                # Escaneamos desde el commit base del PR hasta el HEAD actual
                ./trufflehog git file://$(pwd) \
                    --since-commit ${{ github.event.pull_request.base.sha }} \
                    --results=verified,unverified,unknown \
                    --json > trufflehog.json || true
                else
                # Full scan para el schedule
                ./trufflehog git file://$(pwd) \
                    --results=verified,unverified,unknown \
                    --json > trufflehog.json || true
                fi

          # Convert JSON → SARIF
          - name: Convert JSON to SARIF
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ ! -s trufflehog.json ]; then
                    echo "No findings."
                    exit 0
                fi

                jq -s '
                {
                    "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
                    version: "2.1.0",
                    runs: [
                        {
                            tool: {
                                driver: {
                                    name: "TruffleHog",
                                    informationUri: "https://github.com/trufflesecurity/trufflehog",
                                    rules: (map({id: .DetectorName, name: .DetectorName}) | unique)
                                }
                            },
                            results: map({
                                ruleId: .DetectorName,
                                level: (if .Verified == true then "error" else "warning" end),
                                message: { text: "Secret detected: " + .DetectorName },
                                locations: [{
                                    physicalLocation: {
                                        artifactLocation: {
                                            uri: (.SourceMetadata.Data.Git.file // "unknown")
                                        },
                                        region: {
                                            startLine: ((.SourceMetadata.Data.Git.line // 1) | tonumber)
                                        }
                                    }
                                }]
                            })
                        }
                    ]
                }' trufflehog.json > trufflehog.sarif

          - name: Validate SARIF contains results
            id: sarif_check
            run: |
                if [ -f trufflehog.sarif ] && jq -e '.runs[0].results | length > 0' trufflehog.sarif > /dev/null; then
                    echo "has_results=true" >> $GITHUB_OUTPUT
                else
                    echo "has_results=false" >> $GITHUB_OUTPUT
                fi

          - name: Upload SARIF report
            if: always() && steps.sarif_check.outputs.has_results == 'true'
            uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
            with:
                sarif_file: trufflehog.sarif

          # Fail explicitly if findings exist
          - name: Enforce fail on detection
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ -s trufflehog.json ]; then
                    echo "Secrets detected. Check the Security tab or the logs above."
                    exit 1
                fi
