name: Secret Scanning (TruffleHog)

permissions:
    contents: read
    security-events: write

on:
    pull_request:
        branches:
        - main
    schedule:
        - cron: '0 4 * * 3' # Wednesday 04:00 UTC

concurrency:
    group: trufflehog-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    trufflehog-scan:
        name: TruffleHog OSS Scan
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
          - name: Checkout (full history)
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            with:
                fetch-depth: 0
                persist-credentials: false

          - name: Download and verify TruffleHog
            run: |
                VERSION=3.93.3
                FILE=trufflehog_${VERSION}_linux_amd64.tar.gz
                echo "‚è≥ Downloading TruffleHog v$VERSION..."
                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/${FILE} -o ${FILE}
                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/trufflehog_${VERSION}_checksums.txt -o checksums.txt

                if grep -q "${FILE}" trufflehog_${VERSION}_checksums.txt | sha256sum -c -; then
                    echo "‚úÖ Checksum verified: Integrity Guaranteed."
                else
                    echo "‚ùå CRITICAL: Checksum mismatch! The binary might be tampered."
                    exit 1
                fi

                tar -xzf ${FILE}
                chmod +x trufflehog

          - name: Run TruffleHog (Git scan)
            id: scan_step
            run: |
                if [ "${{ github.event_name }}" == "pull_request" ]; then
                echo "üîç Scanning PR Diff (since ${{ github.event.pull_request.base.sha }})..."
                ./trufflehog git file://$(pwd) \
                    --since-commit ${{ github.event.pull_request.base.sha }} \
                    --results=verified,unverified,unknown \
                    --json > trufflehog.json || echo "scan_failed=true" >> $GITHUB_ENV
                else
                echo "üîç Running Scheduled Full Scan..."
                ./trufflehog git file://$(pwd) \
                    --results=verified,unverified,unknown \
                    --json > trufflehog.json || echo "scan_failed=true" >> $GITHUB_ENV
                fi

          # Convert JSON ‚Üí SARIF
          - name: Convert JSON to SARIF
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ ! -s trufflehog.json ]; then
                    echo "‚ú® No secrets found. Repository is clean."
                    echo "{\"version\":\"2.1.0\",\"runs\":[]}" > trufflehog.sarif
                    exit 0
                fi

                echo "üîÑ Converting NDJSON findings to SARIF format..."
                jq -s '
                {
                    "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
                    version: "2.1.0",
                    runs: [{
                        tool: {
                            driver: {
                                name: "TruffleHog",
                                informationUri: "https://github.com/trufflesecurity/trufflehog",
                                rules: (map({id: .DetectorName, name: .DetectorName}) | unique)
                            }
                        },
                        results: map({
                            ruleId: .DetectorName,
                            level: (if .Verified == true then "error" else "warning" end),
                            message: { text: "Secret detected: \(.DetectorName)" },
                            locations: [{
                                physicalLocation: {
                                    artifactLocation: {
                                        uri: (.SourceMetadata.Data.Git.file // "unknown")
                                    },
                                    region: {
                                        startLine: ((.SourceMetadata.Data.Git.line // 1) | tonumber)
                                    }
                                }
                            }]
                        })
                    }]
                }' trufflehog.json > trufflehog.sarif
                echo "‚úÖ SARIF conversion complete."

          - name: Validate and Upload SARIF report
            if: always() && hashFiles('trufflehog.sarif') != ''
            uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
            with:
                sarif_file: trufflehog.sarif
                # Resolvemos el error de Git pasando los par√°metros expl√≠citos
                checkout_path: ${{ github.workspace }}
                sha: ${{ github.event.pull_request.head.sha || github.sha }}
                ref: ${{ github.event.pull_request.head.ref || github.ref }}

          # Fail explicitly if findings exist
          - name: Enforce fail on detection
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ -s trufflehog.json ]; then
                    COUNT=$(jq -s 'length' trufflehog.json)
                    echo "‚ùå FAILED: $COUNT potential secrets detected!"
                    echo "Please check the 'Security' tab or the SARIF upload artifacts."
                    exit 1
                else
                    echo "‚úÖ PASS: No secrets detected in this run."
                fi
