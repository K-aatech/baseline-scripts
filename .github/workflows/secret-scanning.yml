name: Secret Scanning (TruffleHog)

permissions:
    contents: read
    security-events: write

on:
    pull_request:
        branches:
        - main
    schedule:
        - cron: '0 4 * * 3' # Wednesday 04:00 UTC

concurrency:
    group: trufflehog-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    trufflehog-scan:
        name: TruffleHog OSS Scan
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
          - name: Checkout (full history)
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            with:
                fetch-depth: 0

          - name: Download and verify TruffleHog
            run: |
                VERSION=3.93.3
                FILE=trufflehog_${VERSION}_linux_amd64.tar.gz

                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/${FILE} -o ${FILE}
                curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/trufflehog_${VERSION}_checksums.txt -o checksums.txt

                grep ${FILE} checksums.txt | sha256sum -c -

                tar -xzf ${FILE}
                chmod +x trufflehog

          # PR → diff only
          - name: Run TruffleHog (PR filesystem scan)
            if: github.event_name == 'pull_request'
            run: |
                ./trufflehog filesystem . \
                --results=verified,unverified,unknown \
                --json > trufflehog.json

          # Schedule → full history
          - name: Run TruffleHog (Full scan)
            if: github.event_name == 'schedule'
            run: |
                ./trufflehog git file://. \
                --results=verified,unverified,unknown \
                --json > trufflehog.json

          # Convert JSON → SARIF
          - name: Convert JSON to SARIF
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ ! -s trufflehog.json ]; then
                    echo "No findings."
                    exit 0
                fi

                jq -s '
                {
                    version: "2.1.0",
                    runs: [
                        {
                            tool: {
                                driver: {
                                    name: "TruffleHog",
                                    informationUri: "https://github.com/trufflesecurity/trufflehog"
                                }
                            },
                            results: map({
                                ruleId: (.DetectorName // "SecretDetected"),
                                message: { text: (.Raw // "Secret detected") },
                                locations: [{
                                    physicalLocation: {
                                        artifactLocation: {
                                            uri: .SourceMetadata.Data.Git.file
                                        },
                                        region: {
                                            startLine: (.SourceMetadata.Data.Git.line // 1)
                                        }
                                    }
                                }]
                            })
                        }
                    ]
                }' trufflehog.json > trufflehog.sarif

          - name: Validate SARIF contains results
            id: sarif_check
            run: |
                if [ -f trufflehog.sarif ] && \
                    jq -e '.runs | length > 0 and .[0].results | length > 0' trufflehog.sarif > /dev/null; then
                    echo "has_results=true" >> $GITHUB_OUTPUT
                else
                    echo "has_results=false" >> $GITHUB_OUTPUT
                fi

          - name: Upload SARIF (internal PRs and schedule only)
            if: >
                always() &&
                steps.sarif_check.outputs.has_results == 'true' &&
                (github.event_name == 'schedule' ||
                github.event.pull_request.head.repo.fork == false)
            uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
            with:
                sarif_file: trufflehog.sarif

          # Fail explicitly if findings exist
          - name: Enforce fail on detection
            if: always() && hashFiles('trufflehog.json') != ''
            run: |
                if [ -s trufflehog.json ]; then
                    echo "Secrets detected."
                    exit 1
                fi
